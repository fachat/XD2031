# Compile for Windows on Linux, see doc/README-win32
#
# Verbose compilation:
#
# 	make -f Makefile-win32 V=1

V1=@
V2=@echo 
ifeq ($(V),1)
	V1=
	V2=@\#
endif

DISTDIR=xd2031-win32

CFLAGS=-c -g -W -Wall -pedantic -ansi -std=c99 -funsigned-char -I. -I../common
CFLAGS+=-DSERVER -DUNPRIVILEGED

CROSS=i686-pc-mingw32-
#CROSS=i586-mingw32msvc-
#CFLAGS+=-I$(HOME)/mingw-install/include
#LDFLAGS+=-L$(HOME)/mingw-install/lib

FSSER_EXE=fsser.exe

CC=$(CROSS)gcc
LD=$(CROSS)ld
AR=$(CROSS)ar
PKG_CONFIG=$(CROSS)pkg-config

COMMONC=fsser.c fscmd.c privs.c dir.c log.c fs_provider.c provider.c mem.c xcmd.c os.c
COMMONC+=serial.c channel.c di_provider.c ../common/charconvert.c ../common/wildcard.c
COMMONH=fscmd.h privs.h ../common/wildcard.h dir.h ../common/wireformat.h log.h
COMMONH+=provider.h mem.h types.h xcmd.h os.h ../common/errors.h serial.h channel.h
COMMONH+=../common/petscii.h ../common/charconvert.h 
COMMONC+=curl_provider.c
#COMMONC+=tcp_provider.c 

OBJECTS=$(COMMONC:.c=.o)

#output of `curl-config --libs`
#LIBS=-L/usr/lib/i386-linux-gnu -lcurl -Wl,-Bsymbolic-functions
LIBS=-lcurl -static -Wl,-Bsymbolic-functions -lssh2 -lidn -lgnutls -lwldap32 -lz -lnettle
LIBS+=-lgcrypt -lintl -liconv -lhogweed -lgmp -lgnutls-openssl -lgpg-error -lws2_32 
CFLAGS+=-DCURL_STATICLIB

# fstcp builds a version that listens on a TCP/IP port - but there is not
# device (yet) to use it
#all: fstcp fsser
all: $(COMMONC) $(COMMONH) $(FSSER_EXE)

$(FSSER_EXE): $(OBJECTS)
	$(V2) LINK $@
	$(V1) $(CC) $(LDFLAGS) $(OBJECTS) -o $@ $(LIBS) 

.c.o:
	$(V2) CC $<
	$(V1) $(CC) $(CFLAGS) $< -o $@

clean:
	rm -f $(FSSER_EXE) curltest.exe $(OBJECTS)

distclean:
	rm -rf $(DISTDIR)

run:
	MALLOC_CHECK_=1 wine fsser.exe -d auto -A0:fs=../sample -A1:fs=../tools .

runv:
	# I'm lazy...
	MALLOC_CHECK_=1 wine fsser.exe -v -d auto -A0:fs=../sample -A1:fs=../tools .

runv2:
	# I'm lazy...
	MALLOC_CHECK_=1 wine fsser.exe -v -d auto -A2:fs=../sample -A1:fs=../tools -A0:di=../sample/test2.d64 -A3:ftp=ftp.zimmers.net/pub/cbm/pet -A9:di=../sample/COPYALL\ V2.D64 -Xiec:U=9 . 

run9:
	MALLOC_CHECK_=1 wine fsser.exe -v -d auto -A0:fs=../sample -A1:fs=../tools -Xiec:U=9 -Xieee:U=9 .


curltest: curl_test.c curl_provider.c log.c
	${CC} ${CFLAGS} -o curltest.exe curl_provider.c curl_test.c log.c ${LIBS}

doc:
	mkdir -p ../docsrc/doxygen
	doxygen Doxyfile

dist:	distclean $(FSSER_EXE)
	mkdir -p $(DISTDIR)
	cp -r ../sample $(DISTDIR)
	cp -r ../tools $(DISTDIR)
	cp $(FSSER_EXE) $(DISTDIR)
	cp COPYING $(DISTDIR)/COPYING.txt
	cp StartServer.bat $(DISTDIR)
	find $(DISTDIR) \( -iname *.txt -o -iname *.bat \) -exec unix2dos {} \;
	zip -r $(DISTDIR).zip $(DISTDIR)



.PHONY: all install uninstall run fsser dist doc
